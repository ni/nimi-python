# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

stages:
  - stage: Windows_nimi_bot
    pool:
      name: Users
      demands:
        - nimibot -equals True
        - agent.os -equals Windows_NT
    jobs:
    - job: Windows_nimi_bot_Validate_Codegen
      workspace:
        clean: all
      steps:
        - task: PythonScript@0
          displayName: Validate codegen
          inputs:
            scriptSource: inline
            script: |
              import os
              import sys
              os.system('git config user.email "dummy@ni.com"')
              os.system('git config user.name "dummy"')
              commit_id_before_code_generator = os.system("git log -1 --format=%h")
              os.system("tox -e codegen")
              os.system('git commit -a -m "test"')
              commit_id_after_code_generator = os.system("git log -1 --format=%h")
              if commit_id_before_code_generator != commit_id_after_code_generator:
                print("Please re-generate the codegen using command 'tox -e codegen'", file=sys.stderr)
                sys.exit(-1)
              sys.exit(0)

    - job: Windows_Running_nidcpower_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
      steps:
        - script: | 
            tools\system_tests.bat nidcpower
          displayName: Running nidcpower system tests 

    - job: Windows_Running_nidigital_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
      steps:
        - script: | 
            tools\system_tests.bat nidigital
          displayName: Running nidigital system tests

    - job: Windows_Running_nidmm_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
      steps:
        - script: | 
            tools\system_tests.bat nidmm
          displayName: Running nidmm system tests

    - job: Windows_Running_nifgen_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
        - script: | 
            . .venv/bin/activate || call .venv\Scripts\activate
            tools\system_tests.bat nifgen
          displayName: Running nifgen system tests(few tests are failing)

    # - job: Windows_Running_niscope_system_tests
    #   dependsOn: Windows_nimi_bot_Validate_Codegen 
    #   workspace:
    #     clean: all
        # - script: |
        #     . .venv/bin/activate || call .venv\Scripts\activate
        #     tools\system_tests.bat nimodinst
        #   displayName: Running nimodinst system tests(few tests are failing)

    - job: Windows_Running_niscope_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
        - script: |
            tools\system_tests.bat niscope
          displayName: Running niscope system tests

    - job: Windows_Running_nise_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
        - script: | 
            tools\system_tests.bat nise
          displayName: Running nise system tests

    - job: Windows_Running_niswitch_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
        - script: | 
            tools\system_tests.bat niswitch
          displayName: Running niswitch system tests

    - job: Windows_Running_nitclk_system_tests
      dependsOn: Windows_nimi_bot_Validate_Codegen 
      workspace:
        clean: all
        - script: | 
            tools\system_tests.bat nitclk
          displayName: Running nitclk system tests         
          


