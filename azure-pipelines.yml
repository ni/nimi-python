variables:
- name: clone_depth
  value: 10 
  

# A pipeline with no CI trigger
trigger: none

# specific path
pr:
  branches:
    include:
    - master
    - releases/*
  paths:
    exclude:
    - CHANGELOG.md
    - CONTRIBUTING.md
    - .gitattributes
    - .gitattributes
    - LICENSE
    - VERSION
  drafts: false

stages:

  - stage: ensure_code_gen_up_to_date
    pool:
      name: Users
      demands:
        - nimi-bot -equals True
        - agent.os -equals Linux # This will be changed to Linux later
    jobs:
    - job: ensure_code_gen_up_to_date
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - task: PythonScript@0
          displayName: Ensure codegen up to date
          inputs:
            scriptSource: inline
            script: |
              import os
              import sys
              import subprocess

              # To verify code is generated
              if os.system('git config user.email "dummy@ni.com"') != 0:
                sys.exit(-1)
              if os.system('git config user.name "dummy"') != 0:
                sys.exit(-1)
              commit_id_before_code_generator = os.system("git log -1 --format=%h")
              if os.system("tox -e clean") != 0:
                sys.exit(-1)
              if os.system("tox -e codegen") != 0:
                sys.exit(-1)
              if os.system('git add .') != 0:
                print("Unable to add the files", file=sys.stderr)
                sys.exit(-1)              
              os.system('git commit -m "test"') # return code is 1 if there are files to commit
              commit_id_after_code_generator = os.system("git log -1 --format=%h")
              if commit_id_before_code_generator != commit_id_after_code_generator:
                print("Run codegen and include the generated files in the PR", file=sys.stderr)
                sys.exit(-1)
              print("codgen is up to date")

  - stage: nimi_bot_win64
    dependsOn: ensure_code_gen_up_to_date
    pool:
      name: nimi-bot
      demands:
        - nimi-bot -equals True
        - agent.os -equals Windows_NT
    jobs:
    - job: nidigital_system_tests_win64
      workspace:
        clean: all
      steps:
      - template: .template_system_tests
        parameters:
          module_name: nidigital
          os_name: win64
        # - checkout: self  
        #   clean: true
        #   fetchDepth: $(clone_depth)
        # - script: | 
        #     mkdir generated\junit
        #     mkdir generated\kibana
        #     tools\system_tests.bat nidigital
        #   displayName: nidigital system tests win64

    - job: nitclk_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: | 
            mkdir generated\junit
            mkdir generated\kibana
            cd generated\nitclk
            python -m tox -c tox-system_tests.ini --parallel 4 --parallel-live
          displayName: nitclk system tests win64
          env:
            TOX_PARALLEL_NO_SPINNER: 1

    - job: nifgen_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: | 
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat nifgen
          displayName: nifgen system tests win64

    - job: nidcpower_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: | 
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat nidcpower
          displayName: nidcpower system tests win64

    - job: nidmm_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: | 
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat nidmm
          displayName: nidmm system tests win64

    - job: niscope_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: |
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat niscope
          displayName: niscope system tests win64

    - job: nimodinst_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: |
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat nimodinst
          displayName: nimodinst system tests win64

    - job: nise_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: | 
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat nise
          displayName: nise system tests win64

    - job: niswitch_system_tests_win64
      workspace:
        clean: all
      steps:
        - checkout: self  
          clean: true
          fetchDepth: $(clone_depth)
        - script: | 
            mkdir generated\junit
            mkdir generated\kibana
            tools\system_tests.bat niswitch
          displayName: niswitch system tests win64
